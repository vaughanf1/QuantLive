---
phase: 05-delivery-and-visibility
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/chart.py
  - app/templates/chart.html
  - app/main.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "GET /chart displays a candlestick chart of XAUUSD H1 candles in the browser"
    - "Signal markers (entry arrows) appear on the chart at the correct candle time"
    - "Active signals show SL/TP horizontal price lines on the chart"
    - "Historical signals are color-coded by outcome: green for TP hit, red for SL hit, gray for active/expired"
    - "Chart auto-refreshes candle data and signals every 60 seconds without page reload"
    - "GET /chart/candles returns H1 XAUUSD candle data as JSON with Unix timestamp seconds"
    - "GET /chart/signals returns signal data with outcome colors and marker positions"
  artifacts:
    - path: "app/api/chart.py"
      provides: "Chart REST endpoints: GET /chart, GET /chart/candles, GET /chart/signals"
      exports: ["router"]
    - path: "app/templates/chart.html"
      provides: "HTML page with TradingView Lightweight Charts v5.1 and signal overlays"
      contains: "lightweight-charts"
    - path: "app/main.py"
      provides: "Chart router registered with FastAPI app"
      contains: "chart_router"
    - path: "requirements.txt"
      provides: "jinja2 dependency for chart template rendering"
      contains: "jinja2"
  key_links:
    - from: "app/templates/chart.html"
      to: "app/api/chart.py"
      via: "fetch('/chart/candles') and fetch('/chart/signals') in inline JavaScript"
      pattern: "fetch.*chart/candles"
    - from: "app/api/chart.py"
      to: "app/models/candle.py"
      via: "SQLAlchemy query for H1 XAUUSD candles"
      pattern: "Candle.*XAUUSD.*H1"
    - from: "app/api/chart.py"
      to: "app/models/signal.py"
      via: "SQLAlchemy query for signals with optional outcome join"
      pattern: "Signal.*Outcome"
    - from: "app/main.py"
      to: "app/api/chart.py"
      via: "app.include_router(chart_router)"
      pattern: "chart_router"
---

<objective>
Build a browser-accessible chart page that displays a live XAUUSD candlestick chart using TradingView Lightweight Charts v5.1, with signal markers (entry arrows, SL/TP horizontal lines) and color-coded historical outcomes. Backed by two FastAPI REST endpoints serving candle and signal data as JSON.

Purpose: The chart gives the trader a visual dashboard to see signals in context of price action, verify entry/SL/TP placement visually, and review historical signal performance at a glance.

Output: A `/chart` page accessible in any browser showing an auto-refreshing H1 candlestick chart with signal overlays, served by `/chart/candles` and `/chart/signals` JSON endpoints.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-delivery-and-visibility/05-RESEARCH.md

# Key existing files
@app/main.py
@app/database.py
@app/models/candle.py
@app/models/signal.py
@app/models/outcome.py
@app/api/candles.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chart REST endpoints for candle and signal data</name>
  <files>
    app/api/chart.py
    app/main.py
    requirements.txt
  </files>
  <action>
    1. Add `jinja2>=3.1.0` to `requirements.txt` (required for Jinja2Templates used by the chart HTML endpoint).

    2. Create `app/api/chart.py` with an APIRouter (prefix="/chart", tags=["chart"]).

    3. **GET /chart/candles endpoint:**
       ```python
       @router.get("/candles")
       async def get_chart_candles(
           limit: int = 500,
           session: AsyncSession = Depends(get_session),
       ):
       ```
       - Query Candle table: `WHERE symbol='XAUUSD' AND timeframe='H1' ORDER BY timestamp DESC LIMIT {limit}`
       - Reverse to chronological order
       - Return list of dicts: `[{"time": int(candle.timestamp.timestamp()), "open": float(candle.open), "high": float(candle.high), "low": float(candle.low), "close": float(candle.close)}, ...]`
       - **Critical:** `time` must be Unix seconds (int), NOT ISO string, NOT milliseconds. Lightweight Charts requires this format.
       - **UTC normalization:** `candle.timestamp` from PostgreSQL with `DateTime(timezone=True)` via asyncpg returns tz-aware datetimes, so `.timestamp()` will produce correct UTC-based Unix seconds. However, add a defensive guard: if the datetime is naive (no tzinfo), assume UTC explicitly by using `candle.timestamp.replace(tzinfo=datetime.timezone.utc).timestamp()` to avoid local-timezone conversion on non-UTC dev machines. Import `datetime` at module top.
       - Use `from sqlalchemy import select` and the existing `get_session` dependency from `app.database`.

    4. **GET /chart/signals endpoint:**
       ```python
       @router.get("/signals")
       async def get_chart_signals(
           limit: int = 100,
           session: AsyncSession = Depends(get_session),
       ):
       ```
       - Query Signal table with LEFT JOIN on Outcome: `SELECT signals.*, outcomes.result, outcomes.exit_price, outcomes.pnl_pips FROM signals LEFT JOIN outcomes ON signals.id = outcomes.signal_id ORDER BY signals.created_at DESC LIMIT {limit}`
       - For each signal, compute:
         - `time`: Unix seconds from signal.created_at (int). Apply the same UTC normalization as candles: if `signal.created_at` is naive, use `signal.created_at.replace(tzinfo=datetime.timezone.utc)` before calling `.timestamp()`.
         - `direction`: signal.direction ("BUY" or "SELL")
         - `entry_price`: float(signal.entry_price)
         - `stop_loss`: float(signal.stop_loss)
         - `take_profit_1`: float(signal.take_profit_1)
         - `take_profit_2`: float(signal.take_profit_2)
         - `status`: signal.status
         - `outcome_color`: color based on outcome result:
           - "tp1_hit" or "tp2_hit" -> "#26a69a" (green)
           - "sl_hit" -> "#ef5350" (red)
           - status "active" and no outcome -> "#3179F5" (blue)
           - "expired" or other -> "#888888" (gray)
         - `confidence`: float(signal.confidence)
         - `strategy_name`: (optional: join Strategy table or skip for simplicity -- skip, not critical for chart)
       - Return as list of dicts.

    5. **GET /chart endpoint (HTML page):**
       ```python
       from fastapi import Request
       from fastapi.responses import HTMLResponse
       from fastapi.templating import Jinja2Templates

       templates = Jinja2Templates(directory="app/templates")

       @router.get("/", response_class=HTMLResponse)
       async def chart_page(request: Request):
           return templates.TemplateResponse(request=request, name="chart.html")
       ```

    6. **Register router in app/main.py:**
       - Add import: `from app.api.chart import router as chart_router`
       - Add: `app.include_router(chart_router)`

    7. **Create templates directory:** Ensure `app/templates/` directory exists (create it if needed, even if chart.html is created in Task 2).

    **SQLAlchemy query notes:**
    - Use `select(Signal).outerjoin(Outcome, Signal.id == Outcome.signal_id)` for the signals query.
    - Since Outcome fields are on a separate model, load them via a second query or use `add_columns`. Simplest approach: query signals, then for each, check if outcome exists by querying Outcome separately. OR use `select(Signal, Outcome).outerjoin(...)` to get tuples.
    - Use the tuple approach: `select(Signal, Outcome).outerjoin(Outcome, Signal.id == Outcome.signal_id)` returns `(Signal, Outcome|None)` tuples.
  </action>
  <verify>
    Run: `grep 'jinja2' requirements.txt` confirms jinja2 is listed.
    Run: `python -c "from app.api.chart import router; print('OK')"` succeeds.
    Run: `python -c "from app.main import app; routes = [r.path for r in app.routes]; print('/chart/' in routes or '/chart' in routes)"` prints True.
    Verify app/templates/ directory exists.
  </verify>
  <done>
    Three chart endpoints exist: GET /chart (HTML page), GET /chart/candles (JSON candle data with Unix timestamps), GET /chart/signals (JSON signal data with outcome colors). Chart router is registered in main.py.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create chart HTML template with Lightweight Charts v5.1, signal markers, and auto-refresh</name>
  <files>
    app/templates/chart.html
  </files>
  <action>
    Create `app/templates/chart.html` -- a single HTML page that renders a TradingView Lightweight Charts v5.1 candlestick chart with signal overlays. This is a Jinja2 template but uses no Jinja2 variables (pure static HTML + JS that fetches data from REST endpoints).

    **HTML structure:**
    ```
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>GoldSignal - XAUUSD Chart</title>
        <script src="https://unpkg.com/lightweight-charts@5.1.0/dist/lightweight-charts.standalone.production.js"></script>
        <style>
            /* Dark theme, full-width chart, minimal chrome */
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body { background: #1a1a2e; color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
            #header { padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
            #header h1 { font-size: 20px; font-weight: 600; }
            #header .status { font-size: 13px; color: #888; }
            #chart-container { width: 100%; height: calc(100vh - 60px); }
        </style>
    </head>
    ```

    **Body:**
    - A header bar with "GoldSignal - XAUUSD" title and a status indicator showing last refresh time.
    - A full-width chart container div.

    **JavaScript (inline <script> at bottom of body):**

    1. **Create chart:**
       ```javascript
       const container = document.getElementById('chart-container');
       const chart = LightweightCharts.createChart(container, {
           width: container.clientWidth,
           height: container.clientHeight,
           layout: {
               textColor: '#d1d4dc',
               background: { type: 'solid', color: '#1a1a2e' },
           },
           grid: {
               vertLines: { color: '#2B2B43' },
               horzLines: { color: '#2B2B43' },
           },
           crosshair: { mode: 0 },
           timeScale: {
               timeVisible: true,
               secondsVisible: false,
               borderColor: '#2B2B43',
           },
           rightPriceScale: {
               borderColor: '#2B2B43',
           },
       });
       ```

    2. **Add candlestick series (v5 API):**
       ```javascript
       const candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
           upColor: '#26a69a',
           downColor: '#ef5350',
           borderVisible: false,
           wickUpColor: '#26a69a',
           wickDownColor: '#ef5350',
       });
       ```

    3. **Fetch and render candle data:**
       ```javascript
       async function loadCandles() {
           const resp = await fetch('/chart/candles');
           const data = await resp.json();
           candleSeries.setData(data);
       }
       ```

    4. **Fetch and render signal markers + price lines:**
       ```javascript
       let currentPriceLines = [];

       async function loadSignals() {
           const resp = await fetch('/chart/signals');
           const signals = await resp.json();

           // Build markers array
           const markers = signals.map(s => ({
               time: s.time,
               position: s.direction === 'BUY' ? 'belowBar' : 'aboveBar',
               color: s.outcome_color,
               shape: s.direction === 'BUY' ? 'arrowUp' : 'arrowDown',
               text: `${s.direction} ${s.confidence}%`,
           }));

           // Sort markers by time (required by Lightweight Charts)
           markers.sort((a, b) => a.time - b.time);

           // Set markers (v5 API)
           LightweightCharts.createSeriesMarkers(candleSeries, markers);

           // Remove old price lines
           currentPriceLines.forEach(pl => candleSeries.removePriceLine(pl));
           currentPriceLines = [];

           // Add SL/TP price lines for active signals only
           signals.filter(s => s.status === 'active').forEach(s => {
               currentPriceLines.push(candleSeries.createPriceLine({
                   price: s.entry_price, color: '#3179F5', lineWidth: 1,
                   lineStyle: LightweightCharts.LineStyle.Dashed,
                   axisLabelVisible: true, title: 'Entry',
               }));
               currentPriceLines.push(candleSeries.createPriceLine({
                   price: s.stop_loss, color: '#ef5350', lineWidth: 1,
                   lineStyle: LightweightCharts.LineStyle.Dotted,
                   axisLabelVisible: true, title: 'SL',
               }));
               currentPriceLines.push(candleSeries.createPriceLine({
                   price: s.take_profit_1, color: '#26a69a', lineWidth: 1,
                   lineStyle: LightweightCharts.LineStyle.Dotted,
                   axisLabelVisible: true, title: 'TP1',
               }));
               currentPriceLines.push(candleSeries.createPriceLine({
                   price: s.take_profit_2, color: '#26a69a', lineWidth: 1,
                   lineStyle: LightweightCharts.LineStyle.Dotted,
                   axisLabelVisible: true, title: 'TP2',
               }));
           });
       }
       ```

    5. **Initial load + auto-refresh (60 seconds):**
       ```javascript
       async function refresh() {
           await loadCandles();
           await loadSignals();
           document.getElementById('last-update').textContent =
               'Last update: ' + new Date().toLocaleTimeString();
       }

       refresh().then(() => chart.timeScale().fitContent());
       setInterval(refresh, 60000);
       ```

    6. **Responsive resize:**
       ```javascript
       window.addEventListener('resize', () => {
           chart.resize(container.clientWidth, container.clientHeight);
       });
       ```

    **Style notes:**
    - Dark theme matching TradingView's dark mode aesthetic
    - Full viewport height chart (calc(100vh - header))
    - Minimal header with title and last-refresh timestamp
    - No external CSS files -- all inline in <style> tag
    - Mobile-friendly via viewport meta tag and percentage widths
  </action>
  <verify>
    Verify file exists: `ls app/templates/chart.html` succeeds.
    Verify CDN reference: `grep 'lightweight-charts@5.1.0' app/templates/chart.html` finds the script tag.
    Verify v5 API usage: `grep 'addSeries' app/templates/chart.html` finds v5 pattern (NOT addCandlestickSeries).
    Verify markers API: `grep 'createSeriesMarkers' app/templates/chart.html` finds v5 pattern (NOT setMarkers).
    Verify auto-refresh: `grep 'setInterval' app/templates/chart.html` finds 60-second polling.
    Run full app import check: `python -c "from app.main import app; print('OK')"` succeeds.
  </verify>
  <done>
    Chart HTML template exists at app/templates/chart.html with TradingView Lightweight Charts v5.1 loaded from CDN. Chart displays candlestick data, signal markers (entry arrows color-coded by outcome), SL/TP price lines for active signals, and auto-refreshes every 60 seconds. Dark theme, responsive layout.
  </done>
</task>

</tasks>

<verification>
1. `python -c "from app.main import app; routes = [r.path for r in app.routes]; assert '/chart/' in routes or any('/chart' in r for r in routes); print('chart routes registered')"` passes
2. `python -c "from app.api.chart import get_chart_candles, get_chart_signals, chart_page; print('all endpoints importable')"` passes
3. `ls app/templates/chart.html` succeeds
4. `grep 'lightweight-charts@5.1.0' app/templates/chart.html` finds CDN reference
5. `grep 'addSeries.*CandlestickSeries' app/templates/chart.html` confirms v5 API (not v4)
6. `grep 'createSeriesMarkers' app/templates/chart.html` confirms v5 markers (not setMarkers)
7. `grep 'setInterval' app/templates/chart.html` confirms auto-refresh
8. All existing tests still pass: `PYTHONPATH=. python -m pytest tests/ -x -q`
</verification>

<success_criteria>
- GET /chart serves an HTML page that renders a XAUUSD candlestick chart in the browser
- GET /chart/candles returns H1 candle data as JSON with Unix timestamp seconds
- GET /chart/signals returns signal data with outcome color codes as JSON
- Chart displays entry arrow markers positioned below/above bars based on direction
- Active signals show entry (blue), SL (red), TP1/TP2 (green) horizontal price lines
- Historical signals are color-coded: green = TP hit, red = SL hit, blue = active, gray = expired
- Chart auto-refreshes every 60 seconds without full page reload
- Chart uses TradingView Lightweight Charts v5.1 API (not v4)
- Dark theme with responsive layout
</success_criteria>

<output>
After completion, create `.planning/phases/05-delivery-and-visibility/05-02-SUMMARY.md`
</output>
