---
phase: 04-signal-pipeline
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/gold_intelligence.py
autonomous: true

must_haves:
  truths:
    - "System identifies current gold trading session (Asian/London/NY/overlap)"
    - "Signals generated during London/NY overlap receive +5 confidence boost"
    - "Session metadata is attached to every signal for future analysis"
    - "DXY correlation monitoring computes rolling correlation and flags divergences"
    - "DXY unavailability does not block signal generation"
  artifacts:
    - path: "app/services/gold_intelligence.py"
      provides: "GoldIntelligence service with session identification, confidence adjustment, DXY correlation"
      exports: ["GoldIntelligence", "SessionInfo", "DXYCorrelation"]
      min_lines: 100
  key_links:
    - from: "app/services/gold_intelligence.py"
      to: "app/strategies/helpers/session_filter.py"
      via: "get_active_sessions() for session identification"
      pattern: "get_active_sessions"
    - from: "app/services/gold_intelligence.py"
      to: "app/strategies/base.py"
      via: "modifying CandidateSignal confidence and reasoning"
      pattern: "candidate\\.confidence|candidate\\.reasoning"
---

<objective>
Build the GoldIntelligence service that identifies the current trading session, applies London/NY overlap confidence boost, attaches session metadata to signals, and monitors gold-DXY correlation as informational enrichment.

Purpose: Gold-specific market intelligence that recognizes the unique characteristics of XAUUSD trading sessions and the gold-dollar inverse relationship. Session metadata enables future analysis of which sessions produce the best signals.
Output: `app/services/gold_intelligence.py` with GoldIntelligence class, SessionInfo dataclass, and DXY correlation monitoring.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-signal-pipeline/04-RESEARCH.md

@app/strategies/helpers/session_filter.py
@app/strategies/base.py
@app/models/candle.py
@app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: GoldIntelligence service with session enrichment and DXY correlation</name>
  <files>app/services/gold_intelligence.py</files>
  <action>
Create `app/services/gold_intelligence.py` with these components:

**Configuration constants:**
- OVERLAP_CONFIDENCE_BOOST: int = 5 (confidence points added during London/NY overlap)
- DXY_SYMBOL: str = "DXY" (Twelve Data symbol for Dollar Index)
- DXY_CORRELATION_WINDOW: int = 30 (rolling correlation window in periods)
- DXY_DIVERGENCE_THRESHOLD: float = -0.3 (correlation weaker than this = divergence)

**SessionInfo dataclass:**
- active_sessions: list[str] (e.g., ["london", "new_york", "overlap"])
- is_overlap: bool
- timestamp: datetime

**DXYCorrelation dataclass:**
- correlation: float | None (latest rolling correlation value)
- is_divergent: bool (True if correlation > DXY_DIVERGENCE_THRESHOLD, i.e., less negative)
- available: bool (False if DXY data unavailable)
- message: str (human-readable description)

**GoldIntelligence class:**

1. `def get_session_info(self, timestamp: datetime | None = None) -> SessionInfo`
   - Use get_active_sessions() from app.strategies.helpers.session_filter
   - If timestamp is None, use datetime.now(timezone.utc)
   - Check if "overlap" is in active sessions
   - Return SessionInfo

2. `def enrich(self, candidates: list[CandidateSignal], dxy_info: DXYCorrelation | None = None) -> list[CandidateSignal]`
   - For each candidate:
     a. Get session info for candidate.timestamp
     b. Set candidate.session to primary active session (first in list, or "overlap" if overlap is active)
     c. If overlap is active, boost confidence by OVERLAP_CONFIDENCE_BOOST:
        - new_confidence = min(Decimal(str(float(candidate.confidence) + OVERLAP_CONFIDENCE_BOOST)), Decimal("100"))
        - Create new CandidateSignal with updated confidence (pydantic models are typically immutable, use model_copy(update=...))
        - Append to reasoning: " | London/NY overlap: +5 confidence"
     d. If dxy_info is provided and dxy_info.is_divergent:
        - Append to reasoning: f" | DXY divergence detected (corr={dxy_info.correlation:.2f})"
        - Do NOT reject or modify confidence (informational only per CONTEXT.md decision)
   - Return list of enriched candidates

3. `async def get_dxy_correlation(self, session: AsyncSession) -> DXYCorrelation`
   - Query latest 60 D1 candles for symbol "DXY" from Candle table
   - Query latest 60 D1 candles for symbol "XAUUSD" from Candle table
   - If DXY candles are empty or fewer than DXY_CORRELATION_WINDOW + 5:
     - Return DXYCorrelation(correlation=None, is_divergent=False, available=False, message="DXY data unavailable")
   - Align by timestamp (inner join on dates)
   - Compute rolling Pearson correlation using pandas: gold_close.rolling(DXY_CORRELATION_WINDOW).corr(dxy_close)
   - Get latest correlation value
   - Determine divergence: is_divergent = correlation > DXY_DIVERGENCE_THRESHOLD (weaker inverse)
   - Return DXYCorrelation with values
   - IMPORTANT: Wrap entire method in try/except. On ANY error, log warning and return available=False result. DXY failure must NEVER block the pipeline (Pitfall 7 from RESEARCH.md)

4. `def get_session_volatility_profile(self, session_name: str) -> str`
   - Return qualitative volatility description for context:
     - "asian": "Low volatility (typically 40-60% of London)"
     - "london": "High volatility (London open drives significant price movement)"
     - "new_york": "High volatility (NY open adds liquidity and direction)"
     - "overlap": "Very high volatility (peak liquidity, largest moves)"
   - This is informational metadata, not used for signal decisions (per CONTEXT.md: no session suppression)

**Important implementation notes:**
- get_active_sessions imported from app.strategies.helpers.session_filter (already exists)
- DXY data may not exist in the Candle table yet (Twelve Data may not have DXY on free tier). The service must degrade gracefully.
- For CandidateSignal modification, use pydantic v2's model_copy(update={...}) method
- The enrich() method is synchronous (no DB access needed for session identification). DXY correlation is fetched separately and passed in.
- Float math for correlation, Decimal only for confidence updates at the CandidateSignal boundary
- Comprehensive loguru logging
  </action>
  <verify>
Run: `cd /Users/vaughanfawcett/TradingView && python -c "
from app.services.gold_intelligence import GoldIntelligence, SessionInfo, DXYCorrelation
gi = GoldIntelligence()
info = gi.get_session_info()
print(f'Session info: {info}')
print(f'Volatility profile (overlap): {gi.get_session_volatility_profile(\"overlap\")}')
print('Methods:', [m for m in dir(gi) if not m.startswith('_')])
"` -- should print session info, volatility profile, and list methods (enrich, get_dxy_correlation, get_session_info, get_session_volatility_profile)
  </verify>
  <done>
GoldIntelligence service exists with: get_session_info() identifying active trading sessions, enrich() applying +5 confidence during London/NY overlap and appending DXY divergence notes to reasoning, get_dxy_correlation() computing 30-period rolling Pearson correlation with graceful degradation, and get_session_volatility_profile() returning qualitative session descriptions.
  </done>
</task>

</tasks>

<verification>
- `python -c "from app.services.gold_intelligence import GoldIntelligence, SessionInfo, DXYCorrelation"` imports cleanly
- GoldIntelligence has methods: get_session_info, enrich, get_dxy_correlation, get_session_volatility_profile
- OVERLAP_CONFIDENCE_BOOST is 5
- DXY_DIVERGENCE_THRESHOLD is -0.3
- get_session_info returns SessionInfo with active_sessions list
</verification>

<success_criteria>
- GoldIntelligence is importable and instantiable
- Session identification correctly uses existing get_active_sessions() helper (GOLD-01)
- No session-based suppression -- all sessions allowed (GOLD-02, per CONTEXT.md)
- London/NY overlap adds +5 confidence (GOLD-03)
- DXY correlation is non-blocking, informational only (GOLD-04)
- DXY unavailability returns graceful fallback, never crashes pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/04-signal-pipeline/04-04-SUMMARY.md`
</output>
