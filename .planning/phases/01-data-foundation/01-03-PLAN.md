---
phase: 01-data-foundation
plan: 03
type: tdd
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - tests/__init__.py
  - tests/conftest.py
  - tests/test_candle_ingestor.py
  - tests/test_health.py
  - tests/test_candles_api.py
  - pytest.ini
  - app/services/candle_ingestor.py
autonomous: true

must_haves:
  truths:
    - "Tests verify candle upsert deduplication -- inserting the same candle twice results in one row, not two"
    - "Tests verify gap detection correctly identifies missing candles and ignores weekends"
    - "Tests verify incremental fetch uses latest stored timestamp as start_date"
    - "Tests verify health endpoint returns 200 with database status"
    - "Tests verify candles API endpoint returns correct data with filtering"
    - "Tests verify candle data has UTC-aware timestamps and correct NUMERIC precision"
    - "All tests pass with `pytest` command"
  artifacts:
    - path: "tests/conftest.py"
      provides: "Async test fixtures (db engine, session, FastAPI test client)"
      contains: "pytest_asyncio"
    - path: "tests/test_candle_ingestor.py"
      provides: "Tests for upsert dedup, gap detection, incremental fetch, timezone handling"
      contains: "upsert"
    - path: "tests/test_health.py"
      provides: "Tests for health endpoint"
      contains: "health"
    - path: "tests/test_candles_api.py"
      provides: "Tests for candles REST endpoint"
      contains: "candles"
    - path: "pytest.ini"
      provides: "Pytest configuration with asyncio mode"
      contains: "asyncio_mode"
  key_links:
    - from: "tests/conftest.py"
      to: "app/database.py"
      via: "Override get_session dependency for test database"
      pattern: "dependency_overrides"
    - from: "tests/test_candle_ingestor.py"
      to: "app/services/candle_ingestor.py"
      via: "Direct import and test of CandleIngestor methods"
      pattern: "CandleIngestor"
    - from: "tests/test_candles_api.py"
      to: "app/api/candles.py"
      via: "HTTP client testing via AsyncClient"
      pattern: "client\\.get.*candles"
---

<objective>
Write comprehensive tests for the data pipeline: candle upsert deduplication, gap detection, incremental fetching, timezone correctness, health endpoint, and candles API. Tests use a separate test database and mock Twelve Data API calls.

Purpose: Prove the data pipeline works correctly before moving to Phase 2. Tests catch regressions as the codebase evolves. The TDD approach for gap detection and upsert logic ensures edge cases are covered.

Output: A passing test suite that validates all Phase 1 data pipeline behaviors. Any bugs found during testing are fixed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-foundation/01-RESEARCH.md
@.planning/phases/01-data-foundation/01-01-SUMMARY.md
@.planning/phases/01-data-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test infrastructure and fixtures</name>
  <files>
    tests/__init__.py
    tests/conftest.py
    pytest.ini
  </files>
  <action>
    Set up the async test infrastructure:

    **pytest.ini** -- Pytest configuration:
    ```ini
    [pytest]
    asyncio_mode = auto
    testpaths = tests
    python_files = test_*.py
    python_functions = test_*
    ```

    **tests/__init__.py** -- Empty init file.

    **tests/conftest.py** -- Shared async fixtures following research pattern:

    **Test database setup:**
    - Use a separate test database URL: either from env var `TEST_DATABASE_URL` or construct from `DATABASE_URL` by appending `_test`
    - If the env var is not set, fall back to `postgresql+asyncpg://postgres:postgres@localhost:5432/goldsignal_test`

    **Fixtures:**

    `db_engine` (session-scoped async fixture):
    - Create async engine for test database
    - Create all tables via `Base.metadata.create_all` (run_sync)
    - Yield engine
    - Drop all tables via `Base.metadata.drop_all` (run_sync)
    - Dispose engine

    `db_session` (function-scoped async fixture):
    - Create `async_sessionmaker` from engine
    - Begin a transaction
    - Yield session
    - Rollback transaction after each test (isolation between tests)

    `client` (function-scoped async fixture):
    - Override `get_session` dependency with test session
    - Create `AsyncClient` with `ASGITransport(app=app)` and `base_url="http://test"`
    - Yield client
    - Clear dependency overrides

    `mock_twelve_data` (function-scoped fixture):
    - Use `unittest.mock.patch` to mock `TDClient` from twelvedata
    - Return a mock that produces fake candle data (5 candles with realistic XAUUSD prices like 2645.50, 2646.00, etc.)
    - Mock should return a pandas DataFrame via `.as_pandas()` with DatetimeIndex (UTC-aware) and columns: open, high, low, close, volume

    `sample_candles` (function-scoped fixture):
    - Return a list of 5 candle dicts with known values for testing:
      ```python
      [
          {"symbol": "XAUUSD", "timeframe": "H1", "timestamp": datetime(2026, 2, 16, 10, 0, tzinfo=timezone.utc), "open": Decimal("2645.50"), ...},
          ...
      ]
      ```
    - Use timestamps on a Monday (Feb 16, 2026 is a Monday) to avoid weekend filtering issues

    IMPORTANT: Use `pytest_asyncio.fixture` decorator (not plain `pytest.fixture`) for async fixtures. Use `ASGITransport` for httpx async client (not deprecated `app=` parameter). Rollback after each test for isolation.
  </action>
  <verify>
    ```bash
    test -f pytest.ini && test -f tests/__init__.py && test -f tests/conftest.py
    grep -q "asyncio_mode" pytest.ini
    grep -q "pytest_asyncio" tests/conftest.py
    grep -q "ASGITransport" tests/conftest.py
    grep -q "dependency_overrides" tests/conftest.py
    # Verify pytest discovers the test infrastructure
    python -m pytest --collect-only 2>&1 | head -20
    ```
  </verify>
  <done>Test infrastructure is in place: pytest.ini configured for async, conftest.py has db_engine, db_session, client, mock_twelve_data, and sample_candles fixtures. Test database is isolated from development database.</done>
</task>

<task type="auto">
  <name>Task 2: Write tests for candle ingestor (upsert dedup, gaps, incremental fetch, timezone) and API endpoints</name>
  <files>
    tests/test_candle_ingestor.py
    tests/test_health.py
    tests/test_candles_api.py
    app/services/candle_ingestor.py
  </files>
  <action>
    Write comprehensive tests covering all Phase 1 data pipeline requirements. Fix any bugs discovered during testing.

    **tests/test_health.py** -- Health endpoint tests:
    - `test_health_returns_ok`: GET /health returns 200 with status "ok" and database "connected"
    - `test_health_response_has_timestamp`: Response includes a UTC timestamp
    - `test_health_response_has_version`: Response includes version "0.1.0"

    **tests/test_candle_ingestor.py** -- Core data pipeline tests:

    Upsert deduplication (DATA-02, critical):
    - `test_upsert_creates_candles`: Insert 5 candles, verify 5 rows in database
    - `test_upsert_deduplication`: Insert 5 candles, insert same 5 again, verify still 5 rows (not 10)
    - `test_upsert_updates_on_conflict`: Insert candle with close=2645.50, upsert same candle with close=2646.00, verify stored close is 2646.00

    Gap detection (DATA-03):
    - `test_detect_gaps_finds_missing`: Insert candles at 10:00, 11:00, 13:00 (H1), detect gaps between 10:00-13:00, verify 12:00 is returned as gap
    - `test_detect_gaps_no_gaps`: Insert complete sequence 10:00-14:00 (H1), detect gaps, verify empty result
    - `test_detect_gaps_filters_weekends`: Detect gaps over a range that includes Saturday/Sunday, verify weekend timestamps are NOT reported as gaps

    Incremental fetch (DATA-02 caching):
    - `test_get_latest_timestamp_empty`: No data in DB, returns None
    - `test_get_latest_timestamp_returns_max`: Insert candles, verify max timestamp returned
    - `test_fetch_and_store_backfill`: Mock Twelve Data, call fetch_and_store with empty DB, verify outputsize candles fetched (no start_date param)
    - `test_fetch_and_store_incremental`: Insert some candles, call fetch_and_store, verify start_date is set to latest + 1 interval

    Timezone correctness (DATA-04):
    - `test_stored_candles_have_utc_timezone`: Insert candles, query them back, verify all timestamps have UTC tzinfo
    - `test_fetch_passes_utc_to_twelve_data`: Mock Twelve Data client, call fetch_candles, verify `timezone="UTC"` was passed to the API call

    **tests/test_candles_api.py** -- REST endpoint tests:
    - `test_get_candles_returns_list`: Insert candles, GET /candles/H1, verify returns list of candle objects
    - `test_get_candles_respects_limit`: Insert 10 candles, GET /candles/H1?limit=3, verify 3 returned
    - `test_get_candles_invalid_timeframe`: GET /candles/INVALID, verify 422 or 400 error response
    - `test_get_candles_empty`: GET /candles/H1 with no data, verify empty list returned (not error)

    **Bug fixes in app/services/candle_ingestor.py:**
    - If any test fails, fix the underlying code. Common issues to check:
      - Timezone-naive timestamps (add `.replace(tzinfo=timezone.utc)`)
      - Missing await on async calls
      - Incorrect SQL in gap detection query
      - Wrong interval mapping

    Run full test suite: `pytest -v` and ensure all tests pass.

    IMPORTANT: All tests must use the mock_twelve_data fixture for API calls (never hit real Twelve Data in tests). Use `db_session` fixture for database tests. Use `client` fixture for API endpoint tests. Each test must be independent (no ordering dependencies).
  </action>
  <verify>
    ```bash
    # Run full test suite
    python -m pytest -v --tb=short
    # Verify all tests pass (exit code 0)
    python -m pytest --tb=short; echo "Exit code: $?"
    # Count test cases
    python -m pytest --collect-only -q | tail -1
    ```
  </verify>
  <done>All tests pass. Test suite covers: upsert deduplication (3 tests), gap detection (3 tests), incremental fetch (4 tests), timezone correctness (2 tests), health endpoint (3 tests), candles API (4 tests). Total: ~19 tests. Any bugs found during testing have been fixed in the source code.</done>
</task>

</tasks>

<verification>
Run these checks to confirm Plan 01-03 is complete:

1. `pytest -v` runs all tests with 0 failures
2. Test coverage includes: upsert dedup, gap detection, incremental fetch, timezone, health, candles API
3. No test hits the real Twelve Data API (all mocked)
4. Each test is independent (can run in any order)
5. Test database is cleaned up after test run
</verification>

<success_criteria>
- `pytest -v` passes with 0 failures, ~19 test cases
- Upsert deduplication is proven: same candles inserted twice result in no duplicates
- Gap detection is proven: correctly identifies missing candles, ignores weekends
- Incremental fetch is proven: uses latest stored timestamp to avoid re-fetching
- Timezone correctness is proven: all timestamps are UTC-aware
- Health and candles API endpoints work correctly
- Any bugs found during testing are fixed in source code
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation/01-03-SUMMARY.md`
</output>
